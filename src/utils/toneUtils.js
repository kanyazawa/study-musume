/**
 * キャラクターの口調変換ユーティリティ (v2 - 高品質版)
 *
 * 改善点:
 * - 複合語尾を先に処理して誤爆を防ぐ
 * - 「私」→「俺」を単語境界で限定（「私立」などへの誤爆を防ぐ）
 * - 「〜ね」の変換を文末限定・複合パターン対応
 * - 「〜よ」の変換を精緻化
 * - 「〜てよ」「〜だよね」などの複合パターンを追加
 * - 敬語・丁寧語は変換しない（「ですね」「ますね」を保護）
 */

export const convertTone = (text, characterId) => {
    if (!text) return "";
    if (characterId === 'noah' || characterId === 'noah_3d') return text;
    if (characterId === 'ren') return convertToRenTone(text);
    return text;
};

const convertToRenTone = (text) => {
    let s = text;

    // =========================================================
    // Step 1: 一人称・二人称の変換（単語境界を意識）
    // =========================================================
    // 「私」→「俺」: 「私立」「私的」などへの誤爆を防ぐため、
    // 後ろに助詞（は・が・の・を・に・も・って）が来る場合のみ変換
    s = s.replace(/私(は|が|の|を|に|も|って|、|。|！|？|…|$)/g, "俺$1");
    s = s.replace(/あたし(は|が|の|を|に|も|って|、|。|！|？|…|$)/g, "俺$1");
    s = s.replace(/わたし(は|が|の|を|に|も|って|、|。|！|？|…|$)/g, "俺$1");

    // 二人称
    s = s.replace(/あんた/g, "お前");
    s = s.replace(/アンタ/g, "お前");

    // =========================================================
    // Step 2: 複合語尾（長いものから先に処理して誤爆を防ぐ）
    // =========================================================
    const END = "([。！？…」』]|$)";  // 文末パターン

    // 〜じゃないの → 〜じゃないか
    s = s.replace(new RegExp(`じゃないの${END}`, "g"), "じゃないか$1");
    // 〜じゃないわよ → 〜じゃないぞ
    s = s.replace(new RegExp(`じゃないわよ${END}`, "g"), "じゃないぞ$1");
    // 〜じゃないわ → 〜じゃないな
    s = s.replace(new RegExp(`じゃないわ${END}`, "g"), "じゃないな$1");

    // 〜だよね → 〜だよな
    s = s.replace(new RegExp(`だよね${END}`, "g"), "だよな$1");
    // 〜だよ → 〜だ（文末）
    s = s.replace(new RegExp(`だよ${END}`, "g"), "だ$1");

    // 〜てよ → 〜てくれ
    s = s.replace(new RegExp(`てよ${END}`, "g"), "てくれ$1");
    // 〜のよ → 〜んだ
    s = s.replace(new RegExp(`のよ${END}`, "g"), "んだ$1");
    // 〜わよ → 〜ぞ
    s = s.replace(new RegExp(`わよ${END}`, "g"), "ぞ$1");
    // 〜のね → 〜んだな
    s = s.replace(new RegExp(`のね${END}`, "g"), "んだな$1");
    // 〜わね → 〜だな
    s = s.replace(new RegExp(`わね${END}`, "g"), "だな$1");
    // 〜かしらね → 〜かな
    s = s.replace(new RegExp(`かしらね${END}`, "g"), "かな$1");
    // 〜かしら → 〜かな
    s = s.replace(new RegExp(`かしら${END}`, "g"), "かな$1");

    // 〜だわ → 〜だな
    s = s.replace(new RegExp(`だわ${END}`, "g"), "だな$1");
    // 〜わ（単独） → 〜な
    s = s.replace(new RegExp(`わ${END}`, "g"), "な$1");

    // =========================================================
    // Step 3: 命令・依頼系
    // =========================================================
    // 〜しなさい → 〜しろ
    s = s.replace(/しなさい/g, "しろ");
    // 〜見なさい → 〜見ろ
    s = s.replace(/見なさい/g, "見ろ");
    // 〜聞きなさい → 〜聞け
    s = s.replace(/聞きなさい/g, "聞け");
    // 〜覚えなさい → 〜覚えろ
    s = s.replace(/覚えなさい/g, "覚えろ");
    // 〜やりなさい → 〜やれ
    s = s.replace(/やりなさい/g, "やれ");
    // 〜考えなさい → 〜考えろ
    s = s.replace(/考えなさい/g, "考えろ");
    // 汎用: 動詞 + なさい → 動詞 + ろ（最後の手段）
    s = s.replace(/([いえ])なさい/g, "$1ろ");
    // 〜てちょうだい → 〜てくれ
    s = s.replace(/てちょうだい/g, "てくれ");

    // =========================================================
    // Step 4: 疑問系
    // =========================================================
    // 〜の？ → 〜のか？（敬語「ですの」は除外）
    s = s.replace(/([^すまで])の？/g, "$1のか？");
    // 〜かしら？ → 〜かな？（Step2で処理済みだが念のため）
    s = s.replace(/かしら？/g, "かな？");

    // =========================================================
    // Step 5: 文末の「〜ね」「〜よ」（単独・最後に処理）
    // =========================================================
    // 「ですね」「ますね」「ませんね」は変換しない（敬語保護）
    // → 「[すまん]ね」の前を保護
    // 「〜ね」→「〜な」: 「です/ます/ません」の後は除外
    s = s.replace(/([^すまん])ね([。！？…」』]|$)/g, "$1な$2");

    // 「〜よ。」→「〜だ。」（「ですよ」「ますよ」は除外）
    s = s.replace(/([^すまん])よ([。」』])/g, "$1だ$2");
    // 「〜よ！」→「〜ぞ！」
    s = s.replace(/([^すまん])よ([！])/g, "$1ぞ$2");

    return s;
};
